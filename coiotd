#! /usr/bin/env python

from gi.repository import GLib
from ble import client
import time
import coiot_dbus
import bluez
import pydbus


class CoiotBle:
    def __init__(self):
        self.client = client.BleClient(bluez.DBusBluez().adapters['hci0'])
        time.sleep(2)
        self.client.connect()
        self.devices = {}
        gpios = self.client.get_every_single_gpio()
        for name, gpio in gpios.items():
            for i, g in enumerate(gpio):
                n = name + "-" + str(i)
                d = coiot_dbus.CoiotLamp(g)
                self.devices[n] = d


if __name__ == "__main__":
    coiot = coiot_dbus.CoiotDBus(pydbus.SystemBus(), CoiotBle())
    loop = GLib.MainLoop()
    loop.run()
