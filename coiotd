#! /usr/bin/env python

from gi.repository import GLib
import pydbus
import coiot.dbus
from coiot.device import CoiotDevice
from coiot.db import CoiotDB
import ble.bluez
from ble.client import BleClient
import ble.driver
import logging

if __name__ == "__main__":
    for logn in 'DB', 'DBus', 'Device', 'BLE':
        logging.getLogger(logn).level = logging.DEBUG

    db = CoiotDB('/tmp/coiot.db')
    dev = db.install()
    dev.install_interface(coiot.db.Switchable, On=False)
    dev.install_interface(ble.driver.BLEDriverParameters,
                          Mac="00:00:00:00:00:00")

    adapter = ble.bluez.DBusBluez().adapters['hci0']
    client = BleClient(adapter)
    driver = ble.driver.BluezBLEDriver(client)

    updates = set()
    CoiotDevice.load(db, updates.add)

    def idle_push_updates():
        while updates:
            d = updates.pop()
            d.update()
        return True

    coiot.dbus.CoiotDBus(pydbus.SystemBus())

    loop = GLib.MainLoop()
    GLib.timeout_add(100, idle_push_updates)
    try:
        loop.run()
    finally:
        driver.thread.stop()
